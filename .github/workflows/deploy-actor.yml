name: Deploy Apify Actor

on:
  push:
    branches: [main]
    paths:
      - "apify-actor/**"
  workflow_dispatch: # manual trigger

env:
  APIFY_BASE: https://api.apify.com/v2
  ACTOR_VERSION: "0.2"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Zip the actor source
      - name: Package actor source
        run: cd apify-actor && zip -r ../actor-source.zip . -x "node_modules/*" "dist/*" ".git/*"

      # 2. Upload source to Apify via HTTP
      - name: Upload source to Apify
        run: |
          HTTP_CODE=$(curl -s -o /tmp/upload-response.json -w "%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer ${{ secrets.APIFY_API_TOKEN }}" \
            -H "Content-Type: application/zip" \
            --data-binary @actor-source.zip \
            "${APIFY_BASE}/acts/${{ secrets.APIFY_ACTOR_ID }}/versions/${ACTOR_VERSION}/source-files")

          echo "Upload response (HTTP ${HTTP_CODE}):"
          cat /tmp/upload-response.json

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Upload failed with HTTP ${HTTP_CODE}"
            exit 1
          fi

          echo "Source uploaded successfully"

      # 3. Trigger a build via HTTP
      - name: Trigger Apify build
        id: build
        run: |
          HTTP_CODE=$(curl -s -o /tmp/build-response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.APIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${APIFY_BASE}/acts/${{ secrets.APIFY_ACTOR_ID }}/builds?version=${ACTOR_VERSION}")

          echo "Build response (HTTP ${HTTP_CODE}):"
          cat /tmp/build-response.json

          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Build trigger failed with HTTP ${HTTP_CODE}"
            exit 1
          fi

          BUILD_ID=$(jq -r '.data.id' /tmp/build-response.json)
          echo "build_id=${BUILD_ID}" >> "$GITHUB_OUTPUT"
          echo "Build started: ${BUILD_ID}"

      # 4. Poll build status until complete
      - name: Wait for build to finish
        run: |
          BUILD_ID="${{ steps.build.outputs.build_id }}"
          echo "Waiting for build ${BUILD_ID}..."

          for i in $(seq 1 30); do
            sleep 10

            HTTP_CODE=$(curl -s -o /tmp/build-status.json -w "%{http_code}" \
              -H "Authorization: Bearer ${{ secrets.APIFY_API_TOKEN }}" \
              "${APIFY_BASE}/acts/${{ secrets.APIFY_ACTOR_ID }}/builds/${BUILD_ID}")

            STATUS=$(jq -r '.data.status' /tmp/build-status.json)
            echo "Attempt ${i}/30 â€” status: ${STATUS}"

            case "$STATUS" in
              SUCCEEDED)
                echo "Build succeeded!"
                exit 0
                ;;
              FAILED|ABORTED|TIMED-OUT)
                echo "::error::Build ${STATUS}"
                jq '.data.statusMessage' /tmp/build-status.json
                exit 1
                ;;
            esac
          done

          echo "::error::Build timed out after 5 minutes"
          exit 1
